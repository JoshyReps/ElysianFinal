<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElysianBytes</title>

    <style>
        a {
          text-decoration: none !important;
          border: none;
          background: transparent;
          color: inherit;
          cursor: pointer;
          outline: none;
        }

        .nav-2 {
          font-family: var(--font-fourth);
        }
    </style>

    
    <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,100..900;1,100..900&family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Parkinsans:wght@300..800&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Parisienne&family=Tangerine:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <!-- <section class="loader-wrapper">
        <div class="loader">
            <div class="one"></div>
            <div class="two"></div>
        </div>
    </section> -->

    <nav class="nav-bar flex-center nav-bar-top">
        <div class="nav-con nav-1 flex-center">
          <a href="/" class="nav-1-logo"><img src="images/elysianText.png" alt=""></a>
        </div>
        <div class="nav-2 flex-center">
          <h2 class="admin-header">Admin Dashboard</h2>
        </div>
        <div class="nav-con nav-3 flex-center">
            <div class="but-2 nav-but flex-center">
                <img src="images\icon\logout.svg" alt="">
                <a href="/logout" class="black nav-link-but">
                    Log Out
                </a>
            </div>
        </div>
    </nav> 
    
    <div class="admin-buttons">

      <select id="order">
        <option value="" disabled selected hidden>View Orders</option>
        <option value="normal">Normal Orders</option>
        <option value="custom">Custom Orders</option>
      </select>

      <button id="manage-item">Manage Item</button>
    </div>


    <section id="main-manage-item" class="hidden">
      <div id="manageCakesContainer">

      </div>
    </section>



    <section id="main-admin">

      <div class="filter-row mb-3">
          <input id="searchInput" class="form-control" style="min-width:280px; max-width:520px;" placeholder="Search by email or reference...">
          <select id="verifyFilter" class="form-select" style="width:160px;">
            <option value="all">All Payments</option>
            <option value="verified">Verified</option>
            <option value="unverified">Unverified</option>
          </select>
          <select id="statusFilter" class="form-select" style="width:160px;">
            <option value="all">All Status</option>
            <option value="Pending">Pending</option>
            <option value="Finished">Finished</option>
            <option value="Delivered">Delivered</option>
          </select>
          <button id="resetFilters" class="btn btn-outline-secondary">Reset</button>
      </div>

      <div class="table-responsive">
          <table class="table align-middle">
            <thead class="text-center">
                <tr>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Date</th>
                  <th>Total</th>
                  <th>Reference</th>
                  <th>Proof</th>
                  <th>Verified</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
            </thead>
            <tbody id="paymentsTable">
                <% payments.forEach(p => {
                  const totalPrice = Number(p.total_price || 0).toFixed(2);
                  const verifiedFlag = (typeof p.verified === 'boolean') ? p.verified : (String(p.verified) === 'true');
                  const statusVal = p.status || 'Pending';
                  const orderList = Array.isArray(p.order_list) ? p.order_list : (p.order_list ? JSON.parse(p.order_list) : []);
                  %>
                <tr class="payment-row"
                  data-email="<%= (p.email||'').toLowerCase() %>"
                  data-reference="<%= (p.reference||'').toLowerCase() %>"
                  data-verified="<%= verifiedFlag %>"
                  data-status="<%= statusVal %>">
                  <td class="text-start"><%= p.email || 'N/A' %></td>
                  <td><%= p.phone || 'N/A' %></td>
                  <td><%= p.date || '' %></td>
                  <td class="text-end">₱<%= totalPrice %></td>
                  <td><%= p.reference || '' %></td>
                  <td class="text-center">
                      <% if (p.proof_path) { %>
                      <img src="/<%= p.proof_path %>" class="proof-thumb" alt="proof">
                      <% } else { %>
                      <span class="text-muted small">No proof</span>
                      <% } %>
                  </td>
                  <td class="text-center">
                      <% if (verifiedFlag) { %>
                      <span class="badge bg-success">Verified</span>
                      <% } else { %>
                      <span class="badge bg-secondary">Unverified</span>
                      <% } %>
                  </td>
                  <td class="text-center">
                      <% if (statusVal === 'Delivered') { %>
                      <span class="badge bg-success">Delivered</span>
                      <% } else if (statusVal === 'Finished') { %>
                      <span class="badge bg-info text-dark">Finished</span>
                      <% } else { %>
                      <span class="badge bg-warning text-dark">Pending</span>
                      <% } %>
                  </td>
                  <td class="text-center">
                      <div class="action-buttons">
                        <!-- Buttons are plain buttons; we use confirm modal to POST -->
                        <% if (!verifiedFlag) { %>
                        <button class="btn btn-sm btn-success btn-verify" data-id="<%= p.payment_id %>">Verify</button>
                        <% } %>
                        <% if (verifiedFlag) { %>
                        <% if (statusVal === 'Pending') { %>
                        <button class="btn btn-sm btn-info btn-finish" data-id="<%= p.payment_id %>">Finish</button>
                        <% } else if (statusVal === 'Finished') { %>
                        <button class="btn btn-sm btn-primary btn-deliver" data-id="<%= p.payment_id %>">Mark Delivered</button>
                        <% } %>
                        <% } %>
                        <button class="btn btn-sm btn-danger btn-delete" data-id="<%= p.payment_id %>">Delete</button>
                      </div>
                  </td>
                </tr>
                <tr class="detail-row">
                  <td colspan="9" class="detail-cell">
                      <div class="detail-inner">
                        <strong>Orders:</strong>
                        <% if (orderList && orderList.length) { %>
                        <ul class="mb-0 ms-3">
                            <% orderList.forEach(item => { %>
                            <li><%= item.name %> × <%= item.quantity %></li>
                            <% }) %>
                        </ul>
                        <% } else { %>
                        <div class="text-muted small">No orders found</div>
                        <% } %>
                      </div>
                  </td>
                </tr>
                <% }) %>
            </tbody>
          </table>
      </div>
    </section>
    <div class="modal fade" id="proofModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content p-3">
            <img id="proofModalImg" class="modal-img" src="" alt="Proof">
          </div>
      </div>
    </div>
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <form id="confirmForm" method="POST">
                <div class="modal-header">
                  <h5 class="modal-title" id="confirmTitle">Confirm</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmBody">Are you sure?</div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary">Yes, proceed</button>
                </div>
            </form>
          </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>

      $(document).ready(function() {

        $("#manage-item").on("click", async function (e) {
        e.preventDefault();

        $("#main-manage-item").removeClass("hidden");
        $("#main-admin").addClass("hidden");
        $("#order").val(""); 

        try {
          const html = await $.get("/manage-cakes");
          $("#manageCakesContainer").html(html);
        } catch (err) {
          console.error("Failed to load cakes:", err);
          $("#manageCakesContainer").html("<p class='text-danger'>Failed to load cakes list.</p>");
        }
      });



      $("#order").on("change", function(e) {
        const value = $(this).val();

        if (value === "normal" || value === "custom") {
          $("#main-manage-item").addClass("hidden");
          $("#main-admin").removeClass("hidden");
        }
      });

    });


      $(function(){
        $(document).on('click', '.payment-row', function(e){
          if ($(e.target).closest('button, img').length) return;
          const $detailInner = $(this).next('.detail-row').find('.detail-inner');
          $('.detail-inner').not($detailInner).slideUp(150);
          $detailInner.stop(true, true).slideToggle(180);
        });
      
        $(document).on('click', '.proof-thumb', function(e){
          e.stopPropagation();
          const src = $(this).attr('src');
          $('#proofModalImg').attr('src', src);
          new bootstrap.Modal('#proofModal').show();
        });
      
        function showConfirm(actionUrl, title, body) {
          $('#confirmTitle').text(title);
          $('#confirmBody').text(body);
          $('#confirmForm').attr('action', actionUrl);
          new bootstrap.Modal('#confirmModal').show();
        }
      
        $(document).on('click', '.btn-verify', function(e){
          e.stopPropagation();
          showConfirm(`/admin/verify/${$(this).data('id')}`, 'Verify Payment', 'Mark this payment as verified?');
        });
      

        $(document).on('click', '.btn-finish', function(e){
          e.stopPropagation();
          showConfirm(`/admin/finish/${$(this).data('id')}`, 'Mark Finished', 'Mark this order as Finished?');
        });

      
        $(document).on('click', '.btn-deliver', function(e){
          e.stopPropagation();
          showConfirm(`/admin/deliver/${$(this).data('id')}`, 'Mark Delivered', 'Mark this order as Delivered?');
        });

      
        $(document).on('click', '.btn-delete', function(e){
          e.stopPropagation();
          showConfirm(`/admin/delete/${$(this).data('id')}`, 'Delete Payment', 'Permanently delete this payment record?');
        });

      
        function applyFilters() {
          const q = ($('#searchInput').val() || '').toLowerCase().trim();
          const verifyFilter = $('#verifyFilter').val();
          const statusFilter = $('#statusFilter').val();   
      
          $('#paymentsTable .payment-row').each(function() {
            const $row = $(this);
            const email = String($row.data('email') || '').toLowerCase();
            const reference = String($row.data('reference') || '').toLowerCase();
            const verifiedStr = String($row.data('verified')).toLowerCase();
            const statusStr = String($row.data('status')).toLowerCase();
      
            const matchSearch = !q || email.includes(q) || reference.includes(q);
      
            let matchVerify = true;
            if (verifyFilter === 'verified') matchVerify = verifiedStr === 'true';
            else if (verifyFilter === 'unverified') matchVerify = verifiedStr === 'false';
      
            let matchStatus = true;
            if (statusFilter !== 'all') matchStatus = statusStr === statusFilter.toLowerCase();
      
            if (matchSearch && matchVerify && matchStatus) {
              $row.show();
              $row.next('.detail-row').show().find('.detail-inner').hide();
            } else {
              $row.hide();
              $row.next('.detail-row').hide();
            }
          });
        }
      
        $('#searchInput, #verifyFilter, #statusFilter').on('input change', applyFilters);
        $('#resetFilters').on('click', function(){
          $('#searchInput').val('');
          $('#verifyFilter').val('all');
          $('#statusFilter').val('all');
          applyFilters();
        });
      
        $('#confirmForm').on('submit', function(){
          return true;
        });
      });
    </script>
  </body>
</html>