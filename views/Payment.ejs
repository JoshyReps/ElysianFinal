<% if(locals.user) { %>
    <%- include('header-auth') %>
<% } else { %>
    <%- include('header') %>
<% } %>


  <section id="main-checkout" class="flex-center">

    <h2>Order Checkout</h2>

    <div class="checkout-inner-con flex-center">

      <div class="gcash-con flex-center">
        <h3>Scan to Pay via GCash </h3>
        <div class="gcash-img-con flex-center">
          <img src="images/qr.png" alt="GCash QR" id="img-gcash">
        </div>

        <p>Account Name: <b>ELYSIAN</b></p>
        <p>GCash Number: <b>09xx-xxx-xxxx</b></p>
        <h4>Make sure the account name matches before confirming payment.</h4>
      </div>

      <div class="input-con flex-center">

        <p>
          After sending your payment, please fill in the details below and upload your screenshot for verification.
        </p>

        <% if (type === 'custom') { %>
      <form id="checkout-form-custom" action="/upload-custom" method="POST" enctype="multipart/form-data" class="flex-center">
        <input type="number" name="amount" placeholder="Amount Paid (‚Ç±)" required>
        <input type="text" name="reference" placeholder="13-digit GCash Reference" required pattern="\d{13}">
        <input type="text" name="phone" placeholder="Your GCash Phone Number (09xxxxxxxxx)" required pattern="09\d{9}">

        <label for="proof" class="upload-btn">Upload Payment Screenshot</label>
        <input type="file" id="proof" name="proof" accept="image/*" required>

        <button type="submit" class="btn-custom">Submit Custom Cake Payment Proof</button>
      </form>
    <% } else { %>
    <form id="checkout-form" action="/upload" method="POST" enctype="multipart/form-data" class="flex-center">
      <input type="number" name="amount" placeholder="Amount Paid (‚Ç±)" required>
      <input type="text" name="reference" placeholder="13-digit GCash Reference" required pattern="\d{13}">
      <input type="text" name="phone" placeholder="Your GCash Phone Number (09xxxxxxxxx)" required pattern="09\d{9}">

      <label for="proof" class="upload-btn">Upload Payment Screenshot</label>
      <input type="file" id="proof" name="proof" accept="image/*" required>

      <button type="submit" class="btn-normal">Submit Payment Proof</button>
    </form>
  <% } %>


    </div>

      <div class="submit flex-center">
        
        <% if (locals.reviews) { %>
          <div class="review">
            Review Order :
            <% if (locals.reviews) { reviews.forEach(cake => { %>
              <div class="review-con flex-center">
                <div class="review-img flex-center">
                  <img src="images/new/<%= cake.img %>" alt="">
                </div>
                <div class="review-text">
                  <div class="review-name"><%= cake.name %> x<%= cake.quantity %></div>
                  <div class="review-price">‚Ç±<%= cake.price %></div>
                </div>
              </div>
            <% }) } %>
          </div>
        <% } %>

          <div class="input flex-center">
              <% if (locals.total) { %>
              <% if (locals.orders) { %>
          <div class="flex-center">
              No. Items
              <p><%= orders %></p>
          </div>
            <%}%>
          <div class="flex-center">
            Total
            <p>‚Ç±<%= total %>.00</p>
          </div>
        <% } %>

          <% if (type === 'custom') { %>
            <button type="submit" form="checkout-form-custom" class="btn-custom">
              Submit Custom Cake Payment Proof
            </button>
          <% } else { %>
            <button type="submit" form="checkout-form" class="btn-normal">
              Submit Payment Proof
            </button>
          <% } %>

          <h4>We will verify your payment within 24 hours. You‚Äôll receive a confirmation in your email once verified. Thank you for your patience</h4>
        </div>
      </div>
    </div>


    <div class="order-note">
        <h3>Meet-Up Information : </h3>
        <blockquote>
            Please note: We currently offer <b>meet-up only</b>, not delivery. <br>
            All orders must be placed <b>5‚Äì7 days in advance</b> to give us time to prepare your cake with care. <br> <br>

            Meet-up Location: <br>
            üìç <b>2FCW+4X9, Rasay St, Toril, Davao City, 8000 Davao del Sur</b> <br> <br>

            Once your order is ready and the meet-up time is confirmed, <b>you‚Äôll receive an email notification</b> with the details. <br>
            Kindly make sure you can meet at the given location on your scheduled pickup date and time. 
        </blockquote>
    </div>
  </section>


  <div id="paymentModal" class="modal-overlay" style="display:none;">
    <div class="modal-box flex-center">
      <h3>Payment Proof Submitted</h3>
      <p>Your payment is being verified. You will receive an email once it‚Äôs confirmed.</p>
      <button id="closeModal" class="btn-normal">Okay</button>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const formNormal = document.getElementById("checkout-form");
      const formCustom = document.getElementById("checkout-form-custom");
      const modal = document.getElementById("paymentModal");
      const closeBtn = document.getElementById("closeModal");

      function handleSubmit(form) {
        form.addEventListener("submit", async function(e) {
          e.preventDefault();
          const formData = new FormData(form);

          try {
            const response = await fetch(form.action, {
              method: "POST",
              body: formData
            });
            const result = await response.json();
            if (result.success) {
              modal.style.display = "flex";
              form.reset();
            } else {
              alert("Something went wrong. Please try again.");
            }
          } catch (error) {
            alert("Error submitting payment proof. Please try again.");
            console.error(error);
          }
        });
      }

      if (formNormal) handleSubmit(formNormal);
      if (formCustom) handleSubmit(formCustom);

      closeBtn.addEventListener("click", () => modal.style.display = "none");
    });
  </script>


<%- include('footer') %>
