<section id="manage-cakes" class="flex-center w-100">
  <div class="d-flex justify-content-between align-items-center mb-3 w-100">
    <h2>Manage Cakes</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCakeModal">
      + Add Cake
    </button>
  </div>

  <table class="w-100 table table-bordered text-center align-middle">
    <thead class="table-danger">
      <tr>
        <th>ID</th>
        <th>Image</th>
        <th>Name</th>
        <th>Price</th>
        <th>Upload Image</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% cakes.forEach(cake => { %>
      <tr>
        <td><%= cake.id %></td>
        <td><img src="images/new/<%= cake.img %>" width="100"></td>
        <td>
          <input type="text" class="form-control text-center" name="name" value="<%= cake.name %>" form="updateForm-<%= cake.id %>">
        </td>
        <td>
          <input type="number" class="form-control text-center" name="price" value="<%= cake.price %>" form="updateForm-<%= cake.id %>">
        </td>
        <td>
          <input type="file" class="form-control" name="img" accept="image/*" form="updateForm-<%= cake.id %>">
        </td>
        <td>
          <div id="action-td" class="flex-center">

            <form id="updateForm-<%= cake.id %>" action="/update-cake/<%= cake.id %>" method="POST" enctype="multipart/form-data" class="d-inline">
              <button type="button" class="btn btn-primary btn-sm btn-update" data-cake-id="<%= cake.id %>" data-cake-name="<%= cake.name %>">Update</button>
            </form>

            <button type="button" class="btn btn-danger btn-sm btn-delete-cake"  data-cake-id="<%= cake.id %>" data-cake-name="<%= cake.name %>">
              Delete
            </button>
          </div>
        </td>
      </tr>
      <% }) %>
    </tbody>
  </table>

  <div class="modal fade" id="addCakeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form action="/add-cake" method="POST" enctype="multipart/form-data">
          <div class="modal-header">
            <h5 class="modal-title">Add New Cake</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Cake Name</label>
              <input type="text" name="name" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Price</label>
              <input type="number" name="price" class="form-control" min="0" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Image</label>
              <input type="file" name="img" class="form-control" accept="image/*" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Add Cake</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="deleteCakeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="deleteCakeForm" method="POST">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p id="deleteCakeMessage" class="mb-0"></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">Delete</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="updateConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Confirm Update</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="updateMessage" class="mb-0"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmUpdate">Yes, Update</button>
        </div>
      </div>
    </div>
  </div>

</section>

<script>

  $(function() {

    $(document).on("click", ".btn-delete-cake", function() {
      const cakeId = $(this).data("cake-id");
      const cakeName = $(this).data("cake-name");

      $("#deleteCakeMessage").text(`Are you sure you want to delete "${cakeName}"?`);
      $("#deleteCakeForm").attr("action", `/delete-cake/${cakeId}`);

      const modal = new bootstrap.Modal(document.getElementById("deleteCakeModal"));
      modal.show();
    });

    let pendingForm = null;
    $(document).on("click", ".btn-update", function(e) {
      e.preventDefault();
      pendingForm = $(this).closest("form");
      const cakeName = $(this).data("cake-name");
      $("#updateMessage").text(`Are you sure you want to update "${cakeName}"?`);
      const modal = new bootstrap.Modal(document.getElementById("updateConfirmModal"));
      modal.show();
    });

    $("#confirmUpdate").on("click", function() {
      if (pendingForm) pendingForm.submit();
    });
  });
</script>
